/******************************************************************************
 * @file    example.c
 * @brief   Пример использования библиотеки max17048 для работы с 
 *          MAX17048 по шине I2C в STM32.
 ******************************************************************************/

#include "max17048.h"        // Заголовок библиотеки
#include <stdio.h>           // Для printf
#include <string.h>          // Для memset, если нужно

// Предполагаем, что где-то в проекте объявлен/реализован hi2c1.
extern I2C_HandleTypeDef hi2c1;

/*==============================================================================
 * Пример коллбэка для асинхронных функций
 *==============================================================================
 */
static void MyAsyncCallback(HAL_StatusTypeDef status, void *pUserData)
{
    if (status == HAL_OK)
    {
        // Предположим, мы читали напряжение
        float *pVoltage = (float *)pUserData;
        printf("[ASYNC CB] Напряжение: %.3f В\n", *pVoltage);
    }
    else
    {
        printf("[ASYNC CB] Ошибка чтения!\n");
    }
}

/*==============================================================================
 * Функция main: пример последовательности инициализации и использования
 *==============================================================================
 */
int main(void)
{
    //-------------------------------------------------------------------------
    // 1. Инициализация аппаратуры STM32 (примерно)
    //-------------------------------------------------------------------------
    HAL_Init();              // Инициализация HAL
    SystemClock_Config();    // Настройка системной тактовой частоты
    MX_GPIO_Init();          // Настройка GPIO (если нужно)
    MX_I2C1_Init();          // Настройка I2C (hi2c1)

    //-------------------------------------------------------------------------
    // 2. Инициализация датчика MAX17048
    //-------------------------------------------------------------------------
    if (MAX17048_Init(&hi2c1) == HAL_OK)
    {
        printf("MAX17048 успешно инициализирован.\n");
    }
    else
    {
        printf("Ошибка: не удалось инициализировать MAX17048!\n");
        // Обычно здесь можно остановиться или перейти в safe-mode
    }

    //-------------------------------------------------------------------------
    // 3. Пример чтения версии устройства
    //-------------------------------------------------------------------------
    {
        uint8_t version = 0;
        HAL_StatusTypeDef ret = MAX17048_GetVersion(&hi2c1, version);
        if (ret == HAL_OK)
        {
            // Обратите внимание, что в текущем API version возвращается
            // самим значением функции (можно переоформить при необходимости).
            printf("Версия MAX17048: 0x%02X\n", version);
        }
        else
        {
            printf("Ошибка чтения версии!\n");
        }
    }

    //-------------------------------------------------------------------------
    // 4. Пример чтения напряжения (синхронно)
    //-------------------------------------------------------------------------
    {
        float voltage = 0.0f;
        if (MAX17048_GetVoltage(&hi2c1, &voltage) == HAL_OK)
        {
            printf("Напряжение батареи: %.3f В\n", voltage);
        }
        else
        {
            printf("Ошибка чтения напряжения!\n");
        }
    }

    //-------------------------------------------------------------------------
    // 5. Пример установки порога сброса (Reset Voltage) в 3.0 В
    //    (75 * 40 мВ = 3.0 В)
    //-------------------------------------------------------------------------
    {
        uint8_t threshold = 75; // 3.0 В (40 мВ * 75)
        if (MAX17048_SetResetVoltage(&hi2c1, threshold) == HAL_OK)
        {
            printf("Установлен порог сброса в 3.0 В.\n");
        }
        else
        {
            printf("Ошибка установки порога сброса.\n");
        }
    }

    //-------------------------------------------------------------------------
    // 6. Пример чтения уровня заряда (SOC)
    //-------------------------------------------------------------------------
    {
        float soc = 0.0f;
        if (MAX17048_GetSOC(&hi2c1, &soc) == HAL_OK)
        {
            printf("Уровень заряда (SOC): %.2f%%\n", soc);
        }
        else
        {
            printf("Ошибка чтения SOC!\n");
        }
    }

    //-------------------------------------------------------------------------
    // 7. Пример асинхронного чтения напряжения с использованием коллбэка
    //-------------------------------------------------------------------------
    {
        static float asyncVoltage = 0.0f; // Должна жить до момента вызова коллбэка
        HAL_StatusTypeDef ret = MAX17048_GetVoltage_Async(&hi2c1,
                                                          &asyncVoltage,
                                                          MyAsyncCallback,
                                                          &asyncVoltage);
        if (ret == HAL_OK)
        {
            printf("Асинхронное чтение напряжения запущено...\n");
            // Результат придёт в MyAsyncCallback(...) через прерывание I2C
        }
        else if (ret == HAL_BUSY)
        {
            printf("ASYNC: устройство занято. Повторите позже.\n");
        }
        else
        {
            printf("ASYNC: ошибка запуска операции.\n");
        }
    }

    //-------------------------------------------------------------------------
    // 8. Пример цикла работы: демонстрация чтения ALERT
    //-------------------------------------------------------------------------
    while (1)
    {
        HAL_Delay(1000); // Раз в 1 с проверяем статус

        uint8_t alerts = 0;
        if (MAX17048_GetAlertStatus(&hi2c1, &alerts) == HAL_OK)
        {
            if (alerts != 0)
            {
                printf("Поступили ALERT-флаги: 0x%02X\n", alerts);
                // Можно сбросить часть флагов
                MAX17048_ClearAlertStatus(&hi2c1, alerts);
            }
        }
        else
        {
            printf("Ошибка чтения ALERT-флагов.\n");
        }

        // Допустим, периодически хотим читать напряжение (синхронно)
        float voltage = 0.0f;
        if (MAX17048_GetVoltage(&hi2c1, &voltage) == HAL_OK)
        {
            printf("Периодический опрос: напряжение = %.3f В\n", voltage);
        }

        // ... Другой функционал ...
    }

    //-------------------------------------------------------------------------
    // main() обычно никогда не доходит сюда в STM32
    //-------------------------------------------------------------------------
    // return 0;
}
